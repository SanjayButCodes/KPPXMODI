<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Bird Final</title>

<style>
  body {
    margin: 0;
    background: #70c5ce;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    touch-action: manipulation;
  }
  canvas {
    background: #70c5ce;
  }
</style>
</head>

<body>
<canvas id="game" width="400" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* ========= ASSETS ========= */
const birdImg = new Image();
birdImg.src = "bird.png";

const pipeImg = new Image();
pipeImg.src = "pillar.png";

const deathImg = new Image();
deathImg.src = "death.png";

/* ========= AUDIO ========= */
const flapSound = new Audio("click.mp3");
const dieSound  = new Audio("die.mp3");

/* Mobile audio unlock */
document.body.addEventListener("touchstart", () => {
  flapSound.play().then(() => flapSound.pause());
  dieSound.play().then(() => dieSound.pause());
}, { once: true });

/* ========= AUDIO CONTROL ========= */
let currentSound = null;
let restartQueued = false;

function playSound(sound, force = false) {
  if (currentSound && !force) return;

  if (currentSound && force) {
    currentSound.pause();
    currentSound.currentTime = 0;
  }

  currentSound = sound;
  sound.currentTime = 0;
  sound.play();

  sound.onended = () => {
    if (currentSound === sound) {
      currentSound = null;
      if (restartQueued) location.reload();
    }
  };
}

/* ========= GAME STATE ========= */
let bird = {
  x: 80,
  y: 250,
  w: 40,
  h: 40,
  velocity: 0,
  gravity: 0.4,   // easy mode
  lift: -8,
  rotation: 0
};

let pipes = [];
let frame = 0;
let score = 0;
let gameOver = false;

/* ========= INPUT ========= */
function flap() {
  if (!gameOver) {
    bird.velocity = bird.lift;
    playSound(flapSound);
  } else {
    if (currentSound === dieSound) {
      restartQueued = true;
    } else {
      location.reload();
    }
  }
}

document.addEventListener("click", flap);
document.addEventListener("keydown", e => {
  if (e.code === "Space") flap();
});

/* ========= PIPES ========= */
function addPipe() {
  const gap = 190;
  const top = Math.random() * 220 + 60;
  pipes.push({
    x: canvas.width,
    top,
    bottom: top + gap,
    w: 60,
    passed: false
  });
}

/* ========= GAME LOGIC ========= */
function update() {
  if (gameOver) return;

  bird.velocity += bird.gravity;
  bird.velocity *= 0.98;
  bird.y += bird.velocity;

  bird.rotation = Math.min(Math.max(bird.velocity * 0.05, -0.5), 1);

  if (frame % 110 === 0) addPipe();
  frame++;

  pipes.forEach(p => {
    p.x -= 1.6;

    if (
      bird.x < p.x + p.w &&
      bird.x + bird.w > p.x &&
      (bird.y < p.top || bird.y + bird.h > p.bottom)
    ) endGame();

    if (!p.passed && p.x + p.w < bird.x) {
      score++;
      p.passed = true;
    }
  });

  if (bird.y + bird.h > canvas.height || bird.y < 0) {
    endGame();
  }
}

function endGame() {
  if (gameOver) return;
  gameOver = true;
  playSound(dieSound, true);
}

/* ========= DRAW ========= */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  pipes.forEach(p => {
    ctx.drawImage(pipeImg, p.x, 0, p.w, p.top);
    ctx.drawImage(pipeImg, p.x, p.bottom, p.w, canvas.height);
  });

  ctx.save();
  ctx.translate(bird.x + bird.w / 2, bird.y + bird.h / 2);
  ctx.rotate(bird.rotation);
  ctx.drawImage(birdImg, -bird.w / 2, -bird.h / 2, bird.w, bird.h);
  ctx.restore();

  ctx.fillStyle = "white";
  ctx.font = "30px Arial";
  ctx.fillText(score, 20, 40);

  if (gameOver) {
    ctx.drawImage(deathImg, 50, 200, 300, 200);
    ctx.font = "20px Arial";
    ctx.fillText("Tap to Restart", 130, 450);
  }
}

/* ========= LOOP ========= */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>